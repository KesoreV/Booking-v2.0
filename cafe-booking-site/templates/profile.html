{% extends "base.html" %}

{% block content %}
<div class="profile-dashboard">
    <div class="profile-sidebar">
        <div class="user-card">
            <div class="user-avatar">{{ username[0]|upper }}</div>
            <h2 class="user-name">{{ username }}</h2>
            <p class="user-email">Личный кабинет</p>

            <!-- ПЕРЕКЛЮЧАТЕЛЬ ТЕМЫ -->
            <div class="theme-switcher-block" style="margin: 20px 0; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 10px;">
                <label class="switch-label" style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;">
                    <span><i class="fas fa-adjust"></i> Светлая тема</span>
                    <input type="checkbox" id="theme-toggle" onchange="toggleTheme(this)"
                           {% if current_theme == 'light' %}checked{% endif %}>
                </label>
            </div>

            <div class="user-stats">
                <div class="stat-item"><h4>{{ bonuses }}</h4><p>Бонусов</p></div>
                <div class="stat-item"><h4>{{ bookings|length }}</h4><p>Визитов</p></div>
            </div>

            <div style="margin-top: 30px;">
                <a href="{{ url_for('logout') }}" class="btn-outline" style="width: 100%; display:block; box-sizing:border-box;">Выйти</a>
            </div>
        </div>
    </div>

    <!-- (История бронирований остается без изменений) -->
    <div class="history-section">
        <h2>Мои бронирования</h2>
        {% if bookings %}
            {% for booking in bookings %}
            <div class="ticket-card">
                <div class="ticket-left">
                    <span class="ticket-date-day">{{ booking.date.split('-')[2] }}</span>
                    <span class="ticket-date-month">{{ booking.date.split('-')[1] }}</span>
                </div>
                <div class="ticket-right">
                    <div class="ticket-info">
                        <h3>{{ booking.cafe_name }}</h3>
                        <p>Стол №{{ booking.table_number }} • {{ booking.seats }} персон</p>
                        {% if booking.reschedule_count > 0 %}
                        <p style="color: #ffa502; font-size: 0.8rem;">Перенесено раз: {{ booking.reschedule_count }}/3</p>
                        {% endif %}
                    </div>
                    <div class="ticket-meta">
                        <span class="ticket-time">{{ booking.time }}</span>
                        <div class="ticket-actions" style="margin-top: 10px; display: flex; justify-content: flex-end; gap: 10px;">
                            {% if booking.reschedule_count < 3 %}
                            <button class="btn-reschedule"
                                    onclick="openRescheduleModal('{{ booking.booking_id }}', '{{ booking.date }}', '{{ booking.time }}')">
                                Перенести
                            </button>
                            {% endif %}
                            <a href="{{ url_for('cancel_booking', booking_id=booking.booking_id) }}"
                               class="btn-cancel"
                               onclick="return confirm('При отмене спишется 50 баллов. Продолжить?');">
                               Отменить
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="empty-state">
                <p>Здесь пока пусто.</p>
                <a href="{{ url_for('index') }}" class="btn">Забронировать</a>
            </div>
        {% endif %}
    </div>
</div>

<!-- Модальное окно (без изменений) -->
<div id="reschedule-modal" class="modal">
    <div class="modal-content" style="max-width: 400px; text-align: left;">
        <span class="close-modal" onclick="closeRescheduleModal()">&times;</span>
        <h2 style="margin-top:0;">Перенос брони</h2>
        <form action="{{ url_for('reschedule') }}" method="POST">
            <input type="hidden" name="booking_id" id="reschedule-booking-id">
            <div class="form-group" style="margin-bottom: 15px;">
                <label>Новая дата</label>
                <input type="date" name="new_date" id="reschedule-date" required style="width: 100%; padding: 10px;">
            </div>
            <div class="form-group" style="margin-bottom: 25px;">
                <label>Новое время</label>
                <input type="time" name="new_time" id="reschedule-time" required style="width: 100%; padding: 10px;">
            </div>
            <button type="submit" class="btn" style="width: 100%;">Сохранить</button>
        </form>
    </div>
</div>

<script>
function toggleTheme(checkbox) {
    const theme = checkbox.checked ? 'light' : 'dark';
    if (theme === 'light') {
        document.documentElement.classList.add('light-theme');
    } else {
        document.documentElement.classList.remove('light-theme');
    }

    // Сохраняем локально (для быстродействия)
    localStorage.setItem('theme', theme);

    // Сохраняем в БД
    fetch('/set_theme', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({theme: theme})
    });
}

// ... Остальные скрипты (modal) ...
function openRescheduleModal(id, date, time) {
    document.getElementById('reschedule-modal').style.display = 'block';
    document.getElementById('reschedule-booking-id').value = id;
    document.getElementById('reschedule-date').value = date;
    document.getElementById('reschedule-time').value = time;
}
function closeRescheduleModal() {
    document.getElementById('reschedule-modal').style.display = 'none';
}
window.onclick = function(event) {
    if (event.target == document.getElementById('reschedule-modal')) closeRescheduleModal();
}
</script>
{% endblock %}
