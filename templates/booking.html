{% extends "base.html" %}

{% block content %}

<!-- –î–ê–ù–ù–´–ï –î–õ–Ø JS -->
<div id="cafe-data" data-cafe-id="{{ current_cafe.id }}"></div>

<div class="booking-container">

    <!-- –í–ï–†–•–ù–Ø–Ø –ü–ê–ù–ï–õ–¨ -->
    <div class="booking-header-redesigned">
        <div class="header-main-info">
            <h1 class="cafe-title">{{ current_cafe.name }}</h1>
            <div class="cafe-meta-tags">
                <span class="meta-tag"><i class="fas fa-utensils"></i> {{ current_cafe.cuisine }}</span>
                <span class="meta-tag"><i class="fas fa-wallet"></i> –ß–µ–∫: ~{{ current_cafe.avg_check }}‚ÇΩ</span>
                <span class="meta-tag rating"><i class="fas fa-star"></i> 4.8</span>
            </div>
        </div>

        <div class="header-actions">
             <div class="cafe-selector-wrapper">
                <select id="cafe-selector" onchange="location = this.value;">
                    {% for cafe in all_cafes %}
                    <option value="{{ url_for('booking', cafe=cafe.id) }}" {% if cafe.id == current_cafe.id %}selected{% endif %}>
                        {{ cafe.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <button class="btn-menu-dark" onclick="document.getElementById('menu-modal').style.display='block'">
                <i class="fas fa-book-open"></i> –ú–µ–Ω—é
            </button>
        </div>
    </div>

    <!-- –§–ò–õ–¨–¢–†–´ -->
    <div class="filters-bar">
        <span class="filter-label">–§–∏–ª—å—Ç—Ä —Å—Ç–æ–ª–æ–≤:</span>
        <div class="filter-options">
            <button class="filter-pill active" onclick="filterTables('all')">–í—Å–µ</button>
            <button class="filter-pill" onclick="filterTables(2)">2 —á–µ–ª.</button>
            <button class="filter-pill" onclick="filterTables(4)">4 —á–µ–ª.</button>
            <button class="filter-pill" onclick="filterTables(6)">6+ —á–µ–ª.</button>
        </div>
    </div>

    <!-- –ö–ê–†–¢–ê –ó–ê–õ–ê -->
    <div class="restaurant-map-container">
        <div class="floor-grid"></div>
        <div class="map-door" style="bottom: 0; left: 50%; transform: translateX(-50%);">–í—Ö–æ–¥</div>
        <div class="map-window" style="top: 0; left: 20%; width: 100px; height: 5px;"></div>
        <div class="map-window" style="top: 0; right: 20%; width: 100px; height: 5px;"></div>

        {% for table in tables %}
        {% set status = table_statuses[table.id] %}
        <div class="map-element shape-{{ table.shape }} status-{{ status }} table-spot"
             style="left: {{ table.pos_x }}%; top: {{ table.pos_y }}%; transform: translate(-50%, -50%) rotate({{ table.rotation }}deg);"
             data-id="{{ table.id }}"
             data-seats="{{ table.seats }}"
             data-number="{{ table.number }}"
             {% if status == 'free' %}onclick="selectTable(this)"{% endif %}>
            <span class="table-number">{{ table.number }}</span>
            <div class="table-tooltip">–°—Ç–æ–ª {{ table.number }}<br>{{ table.seats }} –ø–µ—Ä—Å–æ–Ω</div>
            {% for i in range(table.seats) %}
            <div class="chair chair-{{ i }}"></div>
            {% endfor %}
        </div>
        {% endfor %}
    </div>

    <!-- –õ–ï–ì–ï–ù–î–ê -->
    <div class="map-legend">
        <div class="legend-item"><span class="dot free"></span> –°–≤–æ–±–æ–¥–Ω–æ</div>
        <div class="legend-item"><span class="dot occupied"></span> –ó–∞–Ω—è—Ç–æ</div>
        <div class="legend-item"><span class="dot booked"></span> –ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–æ</div>
    </div>

    <!-- –û–¢–ó–´–í–´ (–í–ï–†–ù–£–õ –û–ë–†–ê–¢–ù–û) -->
    <div class="reviews-section">
        <h2 style="color:white; margin-bottom: 20px;">–û—Ç–∑—ã–≤—ã –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π</h2>
        <div class="reviews-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
            {% for review in reviews %}
            <div class="review-card">
                <div class="review-header">
                    <span class="review-author">{{ review.user_name }}</span>
                    <span class="review-rating">
                        {% for i in range(review.rating) %}‚≠ê{% endfor %}
                    </span>
                </div>
                <p class="review-text">{{ review.text }}</p>
                <span class="review-date">{{ review.date }}</span>
            </div>
            {% endfor %}
        </div>
    </div>

</div>

<!-- –ù–ò–ñ–ù–Ø–Ø –ü–ê–ù–ï–õ–¨ -->
<div class="booking-panel" id="booking-panel">
    <div class="panel-header">
        <div class="selected-table-info">
            <span class="label">–í—ã–±—Ä–∞–Ω —Å—Ç–æ–ª:</span>
            <span class="value" id="selected-table-num">‚Ññ --</span>
        </div>
        <div class="selected-table-seats" id="selected-table-seats">-- –º–µ—Å—Ç</div>
    </div>

    <form action="{{ url_for('booking') }}" method="POST" class="booking-form">
        <input type="hidden" name="cafe_id" value="{{ current_cafe.id }}">
        <input type="hidden" name="table_id" id="form-table-id">
        <div class="input-group">
            <input type="date" name="date" value="{{ today }}" min="{{ today }}" required>
        </div>
        <div class="input-group">
            <input type="time" name="time" value="18:00" required>
        </div>
        <button type="submit" class="btn-glow">–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å <i class="fas fa-arrow-right"></i></button>
    </form>
</div>

<!-- –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –ú–ï–ù–Æ -->
<div id="menu-modal" class="modal">
    <div class="modal-content">
        <span class="close-modal" onclick="document.getElementById('menu-modal').style.display='none'">&times;</span>
        <h2>–ú–µ–Ω—é —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞</h2>
        <div class="menu-category">
            <h3>üç£ –û—Å–Ω–æ–≤–Ω–æ–µ</h3>
            <div class="menu-item"><span>–§–∏–ª–∞–¥–µ–ª—å—Ñ–∏—è</span><span class="price">590‚ÇΩ</span></div>
            <div class="menu-item"><span>–ö–∞–ª–∏—Ñ–æ—Ä–Ω–∏—è</span><span class="price">450‚ÇΩ</span></div>
        </div>
        <div class="menu-category">
            <h3>ü•§ –ù–∞–ø–∏—Ç–∫–∏</h3>
            <div class="menu-item"><span>–õ–∏–º–æ–Ω–∞–¥ (0.5)</span><span class="price">250‚ÇΩ</span></div>
        </div>
    </div>
</div>

<script>
let selectedSpot = null;
function filterTables(seats) {
    document.querySelectorAll('.filter-pill').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    const tables = document.querySelectorAll('.table-spot');
    tables.forEach(table => {
        const tableSeats = parseInt(table.dataset.seats);
        if (seats === 'all') {
            table.style.opacity = '1'; table.style.pointerEvents = 'auto';
        } else {
            if (tableSeats == seats) { table.style.opacity = '1'; table.style.pointerEvents = 'auto'; }
            else { table.style.opacity = '0.2'; table.style.pointerEvents = 'none'; }
        }
    });
}
function selectTable(element) {
    if (selectedSpot) selectedSpot.classList.remove('selected');
    selectedSpot = element;
    selectedSpot.classList.add('selected');
    const panel = document.getElementById('booking-panel');
    panel.classList.add('active');
    document.getElementById('selected-table-num').textContent = '‚Ññ' + element.dataset.number;
    document.getElementById('selected-table-seats').textContent = element.dataset.seats + ' –ø–µ—Ä—Å–æ–Ω';
    document.getElementById('form-table-id').value = element.dataset.id;
}
window.onclick = function(event) {
    if (event.target == document.getElementById('menu-modal')) {
        document.getElementById('menu-modal').style.display = "none";
    }
}
</script>

{% endblock %}
